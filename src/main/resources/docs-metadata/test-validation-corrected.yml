# Test Validation Specification - CORRECTED with Actual Database Schema
# Based on verified table and column names from form definitions

validation:
  description: "Database validation for farmer registration API submission"
  testDataFile: "test-farmer-data.json"

  # Expected records in each table after processing
  tables:
    # Main form tables
    farmer_basic_data:
      expectedRecords: 1
      primaryKey: "id"
      validations:
        - field: "c_national_id"
          expectedValue: "123456789012"
        - field: "c_first_name"
          expectedValue: "John"
        - field: "c_last_name"
          expectedValue: "Doe"
        - field: "c_gender"
          expectedValue: "male"
        - field: "c_date_of_birth"
          expectedValue: "1990-01-15"
        - field: "c_marital_status"
          expectedValue: "married"
        - field: "c_mobile_number"
          expectedValue: "+26658123456"
        - field: "c_member_of_cooperative"
          expectedValue: "yes"
        - field: "c_cooperative_name"
          expectedValue: "Maseru Farmers Cooperative"

    farm_location:
      expectedRecords: 1
      primaryKey: "id"
      linkField: "c_parent_id"  # Links to main farmer ID
      validations:
        - field: "c_district"
          expectedValue: "Maseru"
        - field: "c_village"
          expectedValue: "Ha Thetsane"
        - field: "c_communityCouncil"
          expectedValue: "Thetsane Council"
        - field: "c_residency_type"
          expectedValue: "1"  # Rural
        - field: "c_yearsInArea"
          expectedValue: "25"
        - field: "c_ownedRentedLand"
          expectedValue: "2.5"
        - field: "c_totalAvailableLand"
          expectedValue: "3.0"
        - field: "c_cultivatedLand"
          expectedValue: "2.0"

    farmer_registry:  # Used by agricultural activities AND household sections
      expectedRecords: 1
      primaryKey: "id"
      linkField: "c_parent_id"
      validations:
        # Agricultural activities fields
        - field: "c_cropProduction"
          expectedValue: "yes"
        - field: "c_livestockProduction"
          expectedValue: "1"  # Yes
        - field: "c_canReadWrite"
          expectedValue: "yes"
        - field: "c_mainSourceFarmLabour"
          expectedValue: "1"  # Family
        - field: "c_mainSourceLivelihood"
          expectedValue: "farming"
        - field: "c_agriculturalManagementSkills"
          expectedValue: "intermediate"
        - field: "c_mainSourceAgriculturalInfo"
          expectedValue: "extension_services"
        - field: "c_conservationPractices"
          expectedValue: "minimum_tillage,crop_rotation,cover_cropping"
        - field: "c_shocks_hazards"
          expectedValue: "drought,flood,pests"

    farmer_crop_livestck:
      expectedRecords: 1
      primaryKey: "id"
      linkField: "c_parent_id"
      validations:
        - field: "c_hasLivestock"
          expectedValue: "yes"

    farmer_income:
      expectedRecords: 1
      primaryKey: "id"
      linkField: "c_parent_id"
      validations:
        - field: "c_mainSourceIncome"
          expectedValue: "crop_sales"
        - field: "c_income_sources"
          expectedValue: "crop_sales,livestock_sales,remittances"
        - field: "c_gainfulEmployment"
          expectedValue: "no"
        - field: "c_averageAnnualIncome"
          expectedValue: "25000"
        - field: "c_monthlyExpenditure"
          expectedValue: "1500"
        - field: "c_supportProgram"
          expectedValue: "subsidized_inputs,school_feeding"
        - field: "c_everOnISP"
          expectedValue: "yes"
        - field: "c_creditDefault"
          expectedValue: "no"

    farmer_declaration:
      expectedRecords: 1
      primaryKey: "id"
      linkField: "c_parent_id"
      validations:
        - field: "c_declarationConsent"
          expectedValue: "consent_given,data_usage_agreed,terms_accepted"
        - field: "c_declarationFullName"
          expectedValue: "John Doe"
        - field: "c_field13"  # Declaration date
          expectedValue: "2024-01-15"
        - field: "c_registrationStation"
          expectedValue: "Maseru District Office"
        - field: "c_registrationChannel"
          expectedValue: "in_person"

    # Grid/Sub-tables with parent-child relationships
    household_members:
      expectedRecords: 5  # Based on test data
      primaryKey: "id"
      parentField: "c_farmer_id"  # Links to parent farmer
      records:
        - index: 0
          validations:
            - field: "c_memberName"
              expectedValue: "John Doe"
            - field: "c_sex"
              expectedValue: "male"
            - field: "c_date_of_birth"
              expectedValue: "1990-01-15"
            - field: "c_relationship"
              expectedValue: "head"
            - field: "c_participatesInAgriculture"
              expectedValue: "1"  # Yes
            - field: "c_disability"
              expectedValue: "0"  # None

        - index: 1
          validations:
            - field: "c_memberName"
              expectedValue: "Jane Doe"
            - field: "c_sex"
              expectedValue: "female"
            - field: "c_relationship"
              expectedValue: "spouse"
            - field: "c_participatesInAgriculture"
              expectedValue: "1"

    crop_management:
      expectedRecords: 3  # Based on test data
      primaryKey: "id"
      parentField: "c_farmer_id"
      records:
        - index: 0
          validations:
            - field: "c_cropType"
              expectedValue: "1"  # MAIZE
            - field: "c_areaCultivated"
              expectedValue: "1.0"
            - field: "c_areaUnit"
              expectedValue: "hectares"
            - field: "c_bagsHarvested"
              expectedValue: "50"
            - field: "c_fertilizerApplied"
              expectedValue: "yes"
            - field: "c_pesticidesApplied"
              expectedValue: "no"

        - index: 1
          validations:
            - field: "c_cropType"
              expectedValue: "2"  # SORGHUM
            - field: "c_areaCultivated"
              expectedValue: "0.5"
            - field: "c_bagsHarvested"
              expectedValue: "20"

    livestock_details:
      expectedRecords: 2  # Based on test data
      primaryKey: "id"
      parentField: "c_farmer_id"
      records:
        - index: 0
          validations:
            - field: "c_livestockType"
              expectedValue: "cattle"
            - field: "c_numberOfMale"
              expectedValue: "2"
            - field: "c_numberOfFemale"
              expectedValue: "5"

        - index: 1
          validations:
            - field: "c_livestockType"
              expectedValue: "sheep"
            - field: "c_numberOfMale"
              expectedValue: "10"
            - field: "c_numberOfFemale"
              expectedValue: "15"

# SQL Verification Queries
sqlQueries:
  # Check main farmer record exists
  verifyFarmerRecord: |
    SELECT COUNT(*) as count
    FROM farmer_basic_data
    WHERE c_national_id = '123456789012';

  # Check all related forms have parent_id set
  verifyParentLinks: |
    SELECT
      (SELECT COUNT(*) FROM farm_location WHERE c_parent_id = ?) as location_count,
      (SELECT COUNT(*) FROM farmer_registry WHERE c_parent_id = ?) as registry_count,
      (SELECT COUNT(*) FROM farmer_income WHERE c_parent_id = ?) as income_count,
      (SELECT COUNT(*) FROM farmer_declaration WHERE c_parent_id = ?) as declaration_count;

  # Check grid data properly linked
  verifyHouseholdMembers: |
    SELECT COUNT(*) as count
    FROM household_members
    WHERE c_farmer_id = ?;

  verifyCrops: |
    SELECT COUNT(*) as count
    FROM crop_management
    WHERE c_farmer_id = ?;

  verifyLivestock: |
    SELECT COUNT(*) as count
    FROM livestock_details
    WHERE c_farmer_id = ?;

  # Data integrity check
  checkOrphanedGridRows: |
    SELECT
      (SELECT COUNT(*) FROM household_members WHERE c_farmer_id IS NULL) as orphaned_household,
      (SELECT COUNT(*) FROM crop_management WHERE c_farmer_id IS NULL) as orphaned_crops,
      (SELECT COUNT(*) FROM livestock_details WHERE c_farmer_id IS NULL) as orphaned_livestock;

# Test execution notes
notes:
  - "All table names are verified from actual form JSON definitions"
  - "Column names use c_ prefix followed by field ID"
  - "Grid tables link via c_farmer_id field"
  - "Main forms link via c_parent_id field"
  - "No app_fd_ prefix is used in actual table names"
  - "Some forms share tables (e.g., farmer_registry used by multiple sections)"